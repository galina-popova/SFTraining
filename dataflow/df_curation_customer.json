{
	"name": "df_curation_customer",
	"properties": {
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "DS_ingestion_CustomerDim",
						"type": "DatasetReference"
					},
					"name": "sourceIngCustomer"
				},
				{
					"dataset": {
						"referenceName": "DS_Curation_CustomerDim",
						"type": "DatasetReference"
					},
					"name": "sourceCurationCustomer"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "DS_Curation_CustomerDim",
						"type": "DatasetReference"
					},
					"name": "sinkCurationCustomer"
				},
				{
					"dataset": {
						"referenceName": "DS_ingestion_CustomerDim",
						"type": "DatasetReference"
					},
					"name": "sinkCustomerCus2"
				}
			],
			"transformations": [
				{
					"name": "joinCustomer"
				},
				{
					"name": "selectBankStatuses"
				},
				{
					"name": "splitCustomer"
				},
				{
					"name": "derivedColumn1"
				},
				{
					"name": "derivedCChecsum"
				},
				{
					"name": "derivedINGChecksum"
				},
				{
					"name": "derivedColumn2"
				},
				{
					"name": "alterRowUpdate"
				}
			],
			"scriptLines": [
				"source(output(",
				"          CustomerDimId as integer,",
				"          UniqueCustomerNumber as string,",
				"          CustomerName as string,",
				"          Phone as string,",
				"          Email as string,",
				"          BillingAddress as string,",
				"          BillingCity as string,",
				"          BillingPostalCode as string,",
				"          BillingState as string,",
				"          BillingCountryName as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     format: 'table') ~> sourceIngCustomer",
				"source(output(",
				"          CustomerDimId as integer,",
				"          UniqueCustomerNumber as string,",
				"          CustomerName as string,",
				"          Phone as string,",
				"          Email as string,",
				"          BillingAddress as string,",
				"          BillingCity as string,",
				"          BillingPostalCode as string,",
				"          BillingState as string,",
				"          BillingCountryName as string,",
				"          ValidFrom as timestamp,",
				"          ValidTo as timestamp,",
				"          IsActive as boolean",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     format: 'table') ~> sourceCurationCustomer",
				"derivedINGChecksum, derivedCChecsum join(sourceIngCustomer@UniqueCustomerNumber == sourceCurationCustomer@UniqueCustomerNumber,",
				"     joinType:'left',",
				"     broadcast: 'auto')~> joinCustomer",
				"joinCustomer select(mapColumn(",
				"          IngCustomerDimId = sourceIngCustomer@CustomerDimId,",
				"          IngUniqueCustomerNumber = sourceIngCustomer@UniqueCustomerNumber,",
				"          IngCustomerName = sourceIngCustomer@CustomerName,",
				"          IngPhone = sourceIngCustomer@Phone,",
				"          IngEmail = sourceIngCustomer@Email,",
				"          IngBillingAddress = sourceIngCustomer@BillingAddress,",
				"          IngBillingCity = sourceIngCustomer@BillingCity,",
				"          IngBillingPostalCode = sourceIngCustomer@BillingPostalCode,",
				"          IngBillingState = sourceIngCustomer@BillingState,",
				"          IngBillingCountryName = sourceIngCustomer@BillingCountryName,",
				"          IngChecksum = ING_checksum,",
				"          CurCustomerDimId = sourceCurationCustomer@CustomerDimId,",
				"          CurUniqueCustomerNumber = sourceCurationCustomer@UniqueCustomerNumber,",
				"          CurCustomerName = sourceCurationCustomer@CustomerName,",
				"          CurPhone = sourceCurationCustomer@Phone,",
				"          CurEmail = sourceCurationCustomer@Email,",
				"          CurBillingAddress = sourceCurationCustomer@BillingAddress,",
				"          CurBillingCity = sourceCurationCustomer@BillingCity,",
				"          CurBillingPostalCode = sourceCurationCustomer@BillingPostalCode,",
				"          CurBillingState = sourceCurationCustomer@BillingState,",
				"          CurBillingCountryName = sourceCurationCustomer@BillingCountryName,",
				"          CurChecksum = C_checksum",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> selectBankStatuses",
				"selectBankStatuses split(isNull(CurUniqueCustomerNumber),",
				"     IngChecksum != CurChecksum,",
				"     disjoint: true) ~> splitCustomer@(InsertRows, UpdateRows, NoChange)",
				"splitCustomer@InsertRows derive(ValidFrom = currentTimestamp(),",
				"          ValidTo = toTimestamp('3000-01-01 00:00:00', 'yyyy-MM-dd hh:mm:ss'),",
				"          IsActive = 1) ~> derivedColumn1",
				"sourceCurationCustomer derive(C_checksum = sha2(256, UniqueCustomerNumber,CustomerName,CustomerName,Phone,Email,BillingAddress,BillingCity,BillingPostalCode,BillingState,BillingCountryName)) ~> derivedCChecsum",
				"sourceIngCustomer derive(ING_checksum = sha2(256, UniqueCustomerNumber,CustomerName,Phone,Email,BillingAddress,BillingCity,BillingPostalCode,BillingState,BillingCountryName)) ~> derivedINGChecksum",
				"splitCustomer@UpdateRows derive(ValidTo = currentTimestamp()) ~> derivedColumn2",
				"derivedColumn2 alterRow(updateIf(true())) ~> alterRowUpdate",
				"derivedColumn1 sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     input(",
				"          CustomerDimId as integer,",
				"          UniqueCustomerNumber as string,",
				"          CustomerName as string,",
				"          Phone as string,",
				"          Email as string,",
				"          BillingAddress as string,",
				"          BillingCity as string,",
				"          BillingPostalCode as string,",
				"          BillingState as string,",
				"          BillingCountryName as string,",
				"          ValidFrom as timestamp,",
				"          ValidTo as timestamp,",
				"          IsActive as boolean",
				"     ),",
				"     deletable:false,",
				"     insertable:true,",
				"     updateable:false,",
				"     upsertable:false,",
				"     format: 'table',",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     errorHandlingOption: 'stopOnFirstError',",
				"     mapColumn(",
				"          UniqueCustomerNumber = IngUniqueCustomerNumber,",
				"          CustomerName = IngCustomerName,",
				"          Phone = IngPhone,",
				"          Email = IngEmail,",
				"          BillingAddress = IngBillingAddress,",
				"          BillingCity = IngBillingCity,",
				"          BillingPostalCode = IngBillingPostalCode,",
				"          BillingState = IngBillingState,",
				"          BillingCountryName = IngBillingCountryName,",
				"          ValidFrom,",
				"          ValidTo,",
				"          IsActive",
				"     )) ~> sinkCurationCustomer",
				"alterRowUpdate sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     input(",
				"          CustomerDimId as integer,",
				"          UniqueCustomerNumber as string,",
				"          CustomerName as string,",
				"          Phone as string,",
				"          Email as string,",
				"          BillingAddress as string,",
				"          BillingCity as string,",
				"          BillingPostalCode as string,",
				"          BillingState as string,",
				"          BillingCountryName as string",
				"     ),",
				"     deletable:false,",
				"     insertable:true,",
				"     updateable:false,",
				"     upsertable:false,",
				"     format: 'table',",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     errorHandlingOption: 'stopOnFirstError',",
				"     mapColumn(",
				"          UniqueCustomerNumber = IngUniqueCustomerNumber,",
				"          CustomerName = IngCustomerName,",
				"          Phone = IngPhone,",
				"          Email = IngEmail,",
				"          BillingAddress = IngBillingAddress,",
				"          BillingCity = IngBillingCity,",
				"          BillingPostalCode = IngBillingPostalCode,",
				"          BillingState = IngBillingState,",
				"          BillingCountryName = IngBillingCountryName",
				"     )) ~> sinkCustomerCus2"
			]
		}
	}
}